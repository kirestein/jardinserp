name: ðŸš€ Deploy to Railway

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Job 1: Testes e Build
  test-and-build:
    name: ðŸ§ª Test & Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          backend/package-lock.json
          frontend/package-lock.json
    
    - name: ðŸ”§ Install Backend Dependencies
      run: |
        cd backend
        npm ci
        
    - name: ðŸ”§ Install Frontend Dependencies
      run: |
        cd frontend
        npm ci
        
    - name: ðŸ§ª Run Backend Tests (if exists)
      run: |
        cd backend
        npm test --if-present
        
    - name: ðŸ§ª Run Frontend Tests
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false
        
    - name: ðŸ—ï¸ Build Frontend for Production
      run: |
        cd frontend
        npm run build
        
    - name: ðŸ“Š Check Build Size
      run: |
        cd frontend
        ls -la build/
        du -sh build/
        
    - name: ðŸ’¾ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/build/
        retention-days: 1

  # Job 2: Deploy para Railway (apenas em push para main)
  deploy:
    name: ðŸš€ Deploy to Railway
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ðŸ’¾ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/build/
        
    - name: ðŸ”§ Prepare for Production
      run: |
        # Instalar dependÃªncias do backend
        cd backend && npm ci --only=production
        cd ..
        
        # Criar package.json de produÃ§Ã£o
        cat > package.json << 'EOF'
        {
          "name": "sistema-funcionarios-production",
          "version": "1.0.0",
          "description": "Sistema de FuncionÃ¡rios - VersÃ£o de ProduÃ§Ã£o",
          "main": "server-production.js",
          "scripts": {
            "start": "node server-production.js",
            "postinstall": "cd backend && npm install --only=production"
          },
          "dependencies": {
            "express": "^4.18.2",
            "cors": "^2.8.5",
            "sqlite3": "^5.1.6",
            "bcryptjs": "^2.4.3",
            "jsonwebtoken": "^9.0.2",
            "multer": "^1.4.5-lts.1",
            "uuid": "^9.0.1"
          },
          "engines": {
            "node": ">=18.0.0"
          }
        }
        EOF
        
    - name: ðŸš‚ Deploy to Railway
      id: deploy
      uses: railwayapp/railway-deploy@v3
      with:
        railway_token: ${{ secrets.RAILWAY_TOKEN }}
        service: ${{ secrets.RAILWAY_SERVICE_ID }}
        
    - name: ðŸŽ‰ Deployment Success
      if: success()
      run: |
        echo "âœ… Deploy realizado com sucesso!"
        echo "ðŸŒ URL: ${{ steps.deploy.outputs.url }}"
        
    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "âŒ Deploy falhou!"
        echo "ðŸ“‹ Verifique os logs acima para mais detalhes."

  # Job 3: NotificaÃ§Ãµes e Health Check
  post-deploy:
    name: ðŸ” Health Check
    needs: deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: â³ Wait for deployment
      run: sleep 30
      
    - name: ðŸ¥ Health Check
      run: |
        # Tentar fazer health check (se a URL estiver disponÃ­vel)
        if [ ! -z "${{ needs.deploy.outputs.url }}" ]; then
          echo "ðŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
          curl -f "${{ needs.deploy.outputs.url }}/api/health" || echo "âš ï¸ Health check falhou, mas deploy pode estar OK"
        else
          echo "â„¹ï¸ URL nÃ£o disponÃ­vel para health check"
        fi
        
    - name: ðŸ“± Create Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status:** Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ **Environment:** Production" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… **Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ‘¤ **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ [Live Application](${{ needs.deploy.outputs.url }})" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š [Railway Dashboard](https://railway.app/dashboard)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“‹ [Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY